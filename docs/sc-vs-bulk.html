<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2017-11-08 Wed 11:21 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Single cell/bulk RNA-Seq concordance</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Abhishek Sarkar">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<style type="text/css">body {width: 60em; margin:auto} pre.src {overflow:auto}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Single cell/bulk RNA-Seq concordance</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org23d047d">Setup</a></li>
<li><a href="#orgbd22a84">Read the data</a></li>
<li><a href="#org7e333f9">Compute TPM</a></li>
<li><a href="#org6d96f37">Plot bulk vs. single cell TPM</a></li>
<li><a href="#org83123e3">Plot correlation vs number of cells</a></li>
</ul>
</div>
</div>

<div id="outline-container-org23d047d" class="outline-2">
<h2 id="org23d047d">Setup</h2>
<div class="outline-text-2" id="text-org23d047d">
<div class="org-src-container">
<pre class="src src-shell" id="org128549f">sbatch $<span class="org-variable-name">RESOURCES</span> --job-name=ipython3 --output=ipython3.out
<span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/bash</span>
<span class="org-builtin">source</span> activate scqtl
rm -f $<span class="org-variable-name">HOME</span>/.local/share/jupyter/runtime/kernel-aksarkar.json
ipython3 kernel --ip=$(<span class="org-sh-quoted-exec">hostname</span> -i) -f kernel-aksarkar.json
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython" id="org56c7536">%matplotlib inline

<span class="org-keyword">import</span> io
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt
<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> pandas <span class="org-keyword">as</span> pd
<span class="org-keyword">import</span> requests
<span class="org-keyword">import</span> scipy.stats <span class="org-keyword">as</span> sst
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbd22a84" class="outline-2">
<h2 id="orgbd22a84">Read the data</h2>
<div class="outline-text-2" id="text-orgbd22a84">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">def</span> <span class="org-function-name">load_umi_data</span>(min_cell_count=5):
  <span class="org-variable-name">annotations</span> = pd.read_table(<span class="org-string">'/home/aksarkar/projects/singlecell-qtl/data/scqtl-annotation.txt'</span>)
  <span class="org-variable-name">counts</span> = pd.read_table(<span class="org-string">'/home/aksarkar/projects/singlecell-qtl/data/scqtl-counts.txt.gz'</span>, index_col=0)
  <span class="org-variable-name">keep_individuals</span> = annotations[<span class="org-string">'chip_id'</span>].value_counts() &gt; min_cell_count
  <span class="org-variable-name">keep_cells</span> = annotations.<span class="org-builtin">apply</span>(<span class="org-keyword">lambda</span> x: keep_individuals.loc[x[<span class="org-string">'chip_id'</span>]], axis=1)
  <span class="org-variable-name">annotations</span> = annotations.loc[keep_cells.values]
  <span class="org-variable-name">counts</span> = counts.loc[:,keep_cells.values]
  <span class="org-keyword">return</span> counts, annotations, keep_individuals

<span class="org-keyword">def</span> <span class="org-function-name">load_bulk_data</span>(keep_individuals):
  <span class="org-variable-name">counts</span> = pd.read_table(<span class="org-string">'/project2/gilad/data/iPSC/counts_RNAseq_iPSC.txt'</span>, header=0, index_col=0, sep=<span class="org-string">' '</span>)
  <span class="org-variable-name">counts.index</span> = [k.split(<span class="org-string">'.'</span>)[0] <span class="org-keyword">for</span> k <span class="org-keyword">in</span> counts.index]
  <span class="org-variable-name">counts.columns</span> = [<span class="org-string">'NA{}'</span>.<span class="org-builtin">format</span>(k) <span class="org-keyword">for</span> k <span class="org-keyword">in</span> counts.columns]
  <span class="org-variable-name">counts</span> = counts.<span class="org-builtin">filter</span>(items=keep_individuals[keep_individuals].index)
  <span class="org-keyword">return</span> counts
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">umi</span>, <span class="org-variable-name">annotations</span>, <span class="org-variable-name">keep_individuals</span> = load_umi_data()
<span class="org-variable-name">bulk</span> = load_bulk_data(keep_individuals)

umi.shape, bulk.shape
</pre>
</div>

<pre class="example">
((20327, 2261), (14034, 20))

</pre>
</div>
</div>

<div id="outline-container-org7e333f9" class="outline-2">
<h2 id="org7e333f9">Compute TPM</h2>
<div class="outline-text-2" id="text-org7e333f9">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">def</span> <span class="org-function-name">get_gene_lengths</span>():
  <span class="org-variable-name">query</span> = <span class="org-string">"""&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="org-string">&lt;!DOCTYPE Query&gt;</span>
<span class="org-string">&lt;Query  virtualSchemaName = "default" formatter = "TSV" header = "0" uniqueRows = "0" count = "" datasetConfigVersion = "0.6" &gt;</span>
<span class="org-string">&lt;Dataset name = "hsapiens_gene_ensembl" interface = "default" &gt;</span>
<span class="org-string">  &lt;Attribute name = "ensembl_gene_id" /&gt;</span>
<span class="org-string">  &lt;Attribute name = "start_position" /&gt;</span>
<span class="org-string">  &lt;Attribute name = "end_position" /&gt;</span>
<span class="org-string">&lt;/Dataset&gt;</span>
<span class="org-string">&lt;/Query&gt;"""</span>
  <span class="org-variable-name">resp</span> = requests.get(<span class="org-string">'http://www.ensembl.org/biomart/martservice'</span>, params={<span class="org-string">'query'</span>: query})
  <span class="org-keyword">if</span> resp.status_code != 200:
    <span class="org-keyword">raise</span> <span class="org-type">RuntimeError</span>
  <span class="org-keyword">with</span> io.StringIO(resp.text) <span class="org-keyword">as</span> f:
    <span class="org-keyword">return</span> pd.read_table(f, header=<span class="org-constant">None</span>, index_col=0).rename(columns={1: <span class="org-string">'start'</span>, 2: <span class="org-string">'end'</span>})
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">ensembl</span> = get_gene_lengths()
ensembl.head()
</pre>
</div>

<pre class="example">
                  start       end
0                                  
ENSG00000283891  55372940  55373034
ENSG00000251931  59450673  59450772
ENSG00000207766  41691585  41691678
ENSG00000275323  54201473  54208260
ENSG00000276678  10287413  10287482
</pre>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">def</span> <span class="org-function-name">cpm</span>(counts):
  <span class="org-keyword">return</span> counts / counts.<span class="org-builtin">sum</span>(axis=0) * 1e6

<span class="org-keyword">def</span> <span class="org-function-name">tpm</span>(counts, ensembl):
  <span class="org-variable-name">rpk</span> = counts.add(1).rtruediv(ensembl.loc[counts.index].<span class="org-builtin">apply</span>(<span class="org-keyword">lambda</span> x: (x[<span class="org-string">'end'</span>] - x[<span class="org-string">'start'</span>]) / 1e3, axis=1), axis=<span class="org-string">'index'</span>)
  <span class="org-keyword">return</span> cpm(rpk)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">bulk_tpm</span> = tpm(bulk, ensembl)
<span class="org-variable-name">pooled_tpm</span> = tpm(umi.groupby(by=annotations[<span class="org-string">'chip_id'</span>].values, axis=1).agg(np.<span class="org-builtin">sum</span>), ensembl)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d96f37" class="outline-2">
<h2 id="org6d96f37">Plot bulk vs. single cell TPM</h2>
<div class="outline-text-2" id="text-org6d96f37">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">def</span> <span class="org-function-name">plot_concordance</span>(merged, title, filename):
  <span class="org-variable-name">lim</span> = [merged.<span class="org-builtin">min</span>().<span class="org-builtin">min</span>(), merged.<span class="org-builtin">max</span>().<span class="org-builtin">max</span>()]
  plt.clf()
  plt.scatter(merged[<span class="org-string">'x'</span>], merged[<span class="org-string">'y'</span>], alpha=0.25, color=<span class="org-string">'black'</span>)
  plt.plot(lim, lim, color=<span class="org-string">'red'</span>)
  <span class="org-variable-name">ax</span> = plt.gca()
  ax.set_xlim([merged[<span class="org-string">'x'</span>].<span class="org-builtin">min</span>(), merged[<span class="org-string">'x'</span>].<span class="org-builtin">max</span>()])
  ax.set_ylim([merged[<span class="org-string">'y'</span>].<span class="org-builtin">min</span>(), merged[<span class="org-string">'y'</span>].<span class="org-builtin">max</span>()])
  plt.title(title)
  plt.xlabel(<span class="org-string">'scRNA-Seq $\log_2(\mathrm{TPM})$'</span>)
  plt.ylabel(<span class="org-string">'Bulk RNA-Seq $\log_2(\mathrm{TPM})$'</span>)
  plt.savefig(filename)

<span class="org-keyword">def</span> <span class="org-function-name">plot_concordance_by_individual</span>(umi, bulk, output_dir):
  <span class="org-keyword">for</span> k, y <span class="org-keyword">in</span> bulk.groupby(level=0, axis=1):
    <span class="org-variable-name">merged</span> = pd.DataFrame(umi.loc[:,k]).merge(y, left_index=<span class="org-constant">True</span>, right_index=<span class="org-constant">True</span>)
    <span class="org-variable-name">merged.columns</span> = [<span class="org-string">'x'</span>, <span class="org-string">'y'</span>]
    plot_concordance(merged, k, <span class="org-string">'{}/{}.png'</span>.<span class="org-builtin">format</span>(output_dir, k))

<span class="org-keyword">def</span> <span class="org-function-name">corr_by_individual</span>(umi, bulk):
  <span class="org-keyword">for</span> k, y <span class="org-keyword">in</span> bulk.groupby(level=0, axis=1):
    <span class="org-variable-name">merged</span> = pd.DataFrame(umi.loc[:,k]).merge(y, left_index=<span class="org-constant">True</span>, right_index=<span class="org-constant">True</span>)
    <span class="org-variable-name">merged.columns</span> = [<span class="org-string">'x'</span>, <span class="org-string">'y'</span>]
    <span class="org-keyword">yield</span> k, sst.spearmanr(merged[<span class="org-string">'x'</span>], merged[<span class="org-string">'y'</span>])[0]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plot_concordance_by_individual(
  np.log(pooled_tpm) / np.log(2),
  np.log(bulk_tpm) / np.log(2),
  <span class="org-string">'/home/aksarkar/projects/singlecell-qtl/analysis/figure/sc-vs-bulk.org/normed'</span>)
</pre>
</div>

<p>
<img src="figure/sc-vs-bulk.org/normed/NA18498.png" alt="NA18498.png">
<img src="figure/sc-vs-bulk.org/normed/NA18499.png" alt="NA18499.png">
<img src="figure/sc-vs-bulk.org/normed/NA18501.png" alt="NA18501.png">
<img src="figure/sc-vs-bulk.org/normed/NA18502.png" alt="NA18502.png">
<img src="figure/sc-vs-bulk.org/normed/NA18505.png" alt="NA18505.png">
<img src="figure/sc-vs-bulk.org/normed/NA18507.png" alt="NA18507.png">
<img src="figure/sc-vs-bulk.org/normed/NA18508.png" alt="NA18508.png">
<img src="figure/sc-vs-bulk.org/normed/NA18520.png" alt="NA18520.png">
<img src="figure/sc-vs-bulk.org/normed/NA18852.png" alt="NA18852.png">
<img src="figure/sc-vs-bulk.org/normed/NA18853.png" alt="NA18853.png">
<img src="figure/sc-vs-bulk.org/normed/NA18856.png" alt="NA18856.png">
<img src="figure/sc-vs-bulk.org/normed/NA18862.png" alt="NA18862.png">
<img src="figure/sc-vs-bulk.org/normed/NA18870.png" alt="NA18870.png">
<img src="figure/sc-vs-bulk.org/normed/NA19098.png" alt="NA19098.png">
<img src="figure/sc-vs-bulk.org/normed/NA19119.png" alt="NA19119.png">
<img src="figure/sc-vs-bulk.org/normed/NA19128.png" alt="NA19128.png">
<img src="figure/sc-vs-bulk.org/normed/NA19159.png" alt="NA19159.png">
<img src="figure/sc-vs-bulk.org/normed/NA19190.png" alt="NA19190.png">
<img src="figure/sc-vs-bulk.org/normed/NA19210.png" alt="NA19210.png">
<img src="figure/sc-vs-bulk.org/normed/NA19257.png" alt="NA19257.png">
</p>

<div class="org-src-container">
<pre class="src src-ipython">pd.DataFrame(corr_by_individual(pooled, bulk)).set_index(0).rename_axis(<span class="org-string">'individual'</span>)
</pre>
</div>

<pre class="example">
                 1
individual          
NA18498     0.823129
NA18499     0.848467
NA18501     0.843642
NA18502     0.853127
NA18505     0.865661
NA18507     0.866077
NA18508     0.837230
NA18520     0.854679
NA18852     0.858144
NA18853     0.845158
NA18856     0.858604
NA18862     0.846564
NA18870     0.863937
NA19098     0.837114
NA19119     0.837075
NA19128     0.856799
NA19159     0.826672
NA19190     0.852006
NA19210     0.844385
NA19257     0.852831
</pre>
</div>
</div>

<div id="outline-container-org83123e3" class="outline-2">
<h2 id="org83123e3">Plot correlation vs number of cells</h2>
<div class="outline-text-2" id="text-org83123e3">
<p>
Pool, then normalize:
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">def</span> <span class="org-function-name">corr_vs_cell_number</span>(individual, umi, annotations, bulk):
  <span class="org-variable-name">ind</span> = umi.loc[:,(annotations[<span class="org-string">'chip_id'</span>] == individual).values]
  <span class="org-variable-name">bulk</span> = bulk.copy()
  <span class="org-variable-name">bulk</span> /= bulk.<span class="org-builtin">sum</span>(axis=0)
  <span class="org-keyword">for</span> num_cells <span class="org-keyword">in</span> np.concatenate((np.arange(1, 20), np.arange(25, ind.shape[1], 25))):
    <span class="org-variable-name">pooled</span> = ind.sample(n=num_cells, axis=1).agg(np.<span class="org-builtin">sum</span>, axis=1)
    <span class="org-variable-name">pooled</span> /= pooled.<span class="org-builtin">sum</span>(axis=0)
    <span class="org-variable-name">merged</span> = pooled.to_frame().merge(bulk.loc[:,individual].to_frame(),
                                     left_index=<span class="org-constant">True</span>, right_index=<span class="org-constant">True</span>)
    <span class="org-variable-name">merged.columns</span> = [<span class="org-string">'x'</span>, <span class="org-string">'y'</span>]
    <span class="org-keyword">yield</span> num_cells, sst.spearmanr(merged[<span class="org-string">'x'</span>], merged[<span class="org-string">'y'</span>])[0]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">pd.DataFrame(corr_vs_cell_number(<span class="org-string">'NA18507'</span>, umi, annotations, bulk)).rename(columns={0: <span class="org-string">'num_cells'</span>, 1: <span class="org-string">'spearmanr'</span>})
</pre>
</div>

<pre class="example">
  num_cells  spearmanr
0           1   0.627287
1           2   0.711947
2           3   0.738548
3           4   0.777475
4           5   0.801505
5           6   0.801581
6           7   0.815715
7           8   0.820436
8           9   0.798678
9          10   0.834730
10         11   0.829013
11         12   0.812909
12         13   0.827369
13         14   0.839966
14         15   0.839457
15         16   0.843704
16         17   0.845752
17         18   0.841247
18         19   0.839174
19         25   0.845794
20         50   0.855858
21         75   0.862241
22        100   0.861110
23        125   0.862727
24        150   0.865433
25        175   0.865231
26        200   0.865497
27        225   0.865995
</pre>

<p>
Normalize, then pool, then normalize again:
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">def</span> <span class="org-function-name">plot_concordance_vs_cell_number</span>(individual, umi, annotations, bulk, output_dir):
  <span class="org-variable-name">ind</span> = umi.loc[:,(annotations[<span class="org-string">'chip_id'</span>] == individual).values]
  <span class="org-variable-name">bulk</span> = bulk.copy()
  <span class="org-variable-name">bulk</span> /= bulk.<span class="org-builtin">sum</span>(axis=0)
  <span class="org-keyword">for</span> num_cells <span class="org-keyword">in</span> [100, 200]:
    <span class="org-variable-name">pooled</span> = ind.sample(n=num_cells, axis=1)
    <span class="org-variable-name">pooled</span> /= pooled.<span class="org-builtin">sum</span>()
    <span class="org-variable-name">pooled</span> = pooled.agg(np.<span class="org-builtin">sum</span>, axis=1)
    <span class="org-variable-name">merged</span> = pooled.to_frame().merge(bulk.loc[:,individual].to_frame(),
                                     left_index=<span class="org-constant">True</span>, right_index=<span class="org-constant">True</span>)
    <span class="org-variable-name">merged.columns</span> = [<span class="org-string">'x'</span>, <span class="org-string">'y'</span>]
    plot_concordance(
      merged,
      <span class="org-string">'{}, {} cell{}'</span>.<span class="org-builtin">format</span>(individual, num_cells, <span class="org-string">'s'</span> <span class="org-keyword">if</span> num_cells &gt; 1 <span class="org-keyword">else</span> <span class="org-string">''</span>),
      <span class="org-string">'{}/{}.png'</span>.<span class="org-builtin">format</span>(output_dir, num_cells))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plot_concordance_vs_cell_number(<span class="org-string">'NA18507'</span>, umi, annotations, bulk, <span class="org-string">'/home/aksarkar/projects/singlecell-qtl/analysis/figure/sc-vs-bulk.org/vs-cells'</span>)
</pre>
</div>

<p>
<img src="figure/sc-vs-bulk.org/vs-cells/100.png" alt="100.png">
<img src="figure/sc-vs-bulk.org/vs-cells/200.png" alt="200.png">
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Abhishek Sarkar</p>
<p class="date">Created: 2017-11-08 Wed 11:21</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
