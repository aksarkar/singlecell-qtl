#+TITLE: NB estimation
#+SETUPFILE: setup.org

* Setup

  #+BEGIN_SRC emacs-lisp
    (org-babel-lob-ingest "/home/aksarkar/projects/singlecell-qtl/analysis/qtl-mapping.org")
    (org-babel-lob-ingest "/home/aksarkar/.emacs.d/org-templates/library.org")
  #+END_SRC

  #+RESULTS:
  : 1

  #+CALL: ipython3(venv="scqtl", partition="gpu2")

  #+RESULTS:
  : Submitted batch job 41382582

  #+BEGIN_SRC ipython
    %matplotlib inline

    import edward as ed
    import functools
    import numpy as np
    import pandas as pd
    import pickle
    import tensorflow as tf
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  :END:

* Data

  #+BEGIN_SRC ipython
    with open('test_data.pkl', 'rb') as f:
      data = pickle.load(f)
    data.keys()
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  : dict_keys(['onehot', 'genotypes', 'counts', 'normalizers'])
  :END:

* Model specification and inference

  #+BEGIN_SRC ipython
    n, p = data['genotypes'].shape
    m, _ = data['onehot'].shape

    onehot = tf.placeholder(tf.float32, [m, n])
    genotypes = tf.placeholder(tf.float32, [n, p])
    normalizers = tf.placeholder(tf.float32, [m, 1])

    mean_bias = ed.models.Normal(loc=tf.zeros([n, 1]), scale=tf.ones([n, 1]))
    mean = tf.exp(tf.matmul(onehot, mean_bias))
    counts = ed.models.Poisson(rate=mean)

    q_mean_bias = ed.models.NormalWithSoftplusScale(
      loc=tf.Variable(tf.random_normal([n, 1])),
      scale=tf.Variable(tf.random_normal([n, 1])))

    inf = ed.KLqp(
      latent_vars={mean_bias: q_mean_bias},
      data={globals()[k]: v for k, v in data.items()})
    inf.run()
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  :END:

  #+BEGIN_SRC ipython
    ed.get_session().run(mean_bias)
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  #+BEGIN_EXAMPLE
  array([[-0.6086905 ],
           [ 0.81585544],
           [ 0.39037457],
           [ 0.1272105 ],
           [ 0.98086077],
           [ 0.58910024],
           [ 0.12276047],
           [-1.11089456],
           [ 0.31234893],
           [ 0.66165096],
           [-1.23624706],
           [-0.62890494],
           [ 0.16324095],
           [ 0.83957553],
           [-1.85474634],
           [ 1.13695812],
           [ 0.29519737],
           [-1.38317037],
           [ 0.2154126 ],
           [ 1.12352216],
           [ 1.03684735]], dtype=float32)
  #+END_EXAMPLE
  :END:
