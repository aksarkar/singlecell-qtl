---
title: "Correlations"
author: "John Blischak"
date: 2017-08-14
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```

<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

## Setup

```{r packages, message=FALSE}
library("dplyr")
library("edgeR")
library("readr")
library("stringr")
```

Import molecules.

```{r import-molecules, message=FALSE, cache=FALSE}
molecules <- read_tsv(gzfile("../data/molecules.txt.gz"))
dim(molecules)
molecules[1:5, 1:10]
colnames(molecules)[1:20]
```

Import annotation.

```{r read-anno, message=FALSE}
anno <- read_tsv("../data/batch1_qc.txt",
                 col_types = cols(ERCC = col_character()))
# Cleanup ERCC column
anno$ERCC <- ifelse(is.na(anno$ERCC), "Not added", anno$ERCC)
anno$ERCC <- factor(anno$ERCC, levels = c("Not added", "1:100000", "1:50000"),
                    labels = c("Not added", "100x dilution", "50x dilution"))
anno$ERCC <- as.character(anno$ERCC)
dim(anno)
colnames(anno)
```

Merge the data sets.

```{r merge}
mol_anno <- merge(molecules, anno, by = c("experiment", "well"))
stopifnot(nrow(mol_anno) == nrow(molecules))
```

Remove samples with bad cell number or TRA-1-60.

```{r filter}
mol_anno <- mol_anno %>%
  filter(cell_number == 1, tra1.60 == 1)
dim(mol_anno)
```

Separate by source.

```{r separate-by-source}
mol_ce <- mol_anno %>% select(experiment:id, cell_number:index, starts_with("WBGene"))
mol_dm <- mol_anno %>% select(experiment:id, cell_number:index, starts_with("FBGn"))
mol_ercc <- mol_anno %>% select(experiment:id, cell_number:index, starts_with("ERCC"))
mol_hs <- mol_anno %>% select(experiment:id, cell_number:index, starts_with("ENSG"))
```

## ERCC

Remove dashes in column names.

```{r dashes}
colnames(mol_ercc) <- str_replace(colnames(mol_ercc), "-", "")
```

Remove samples that did not receive ERCC spike-in and change the name.

```{r ercc-not-added}
mol_ercc <- mol_ercc %>% filter(ERCC != "Not added") %>% rename(annoERCC = ERCC)
```

Remove zeros.

```{r}
mol_ercc <- mol_ercc %>%
  select_if(function(col) is.character(col) || sum(col) > 0)
dim(mol_ercc)
```

Convert to matrix.

```{r}
mol_ercc_mat <- mol_ercc %>%
  select(starts_with("ERCC")) %>%
  t
```

Only keep ERCC which are observed in at least 50% of the samples.

```{r}
present <- function(x, percent = 0.50) mean(x > 0) >= percent
mol_ercc_mat <- mol_ercc_mat[apply(mol_ercc_mat, 1, present), ]
dim(mol_ercc_mat)
mol_ercc_cpm <- cpm(mol_ercc_mat, log = TRUE)
```

Calculate pairwise correlations.

```{r cor-ercc}
cor_ercc <- cor(mol_ercc_cpm)
cor_ercc <- cor_ercc[upper.tri(cor_ercc)]
summary(cor_ercc)
```

## Drosophila

Remove zeros.

```{r}
mol_dm <- mol_dm %>%
  select_if(function(col) is.character(col) || sum(col) > 0)
dim(mol_dm)
```

Convert to matrix.

```{r}
mol_dm_mat <- mol_dm %>%
  select(starts_with("FBgn")) %>%
  t
```

Only keep fly genes which are observed in at least 50% of the samples.

```{r}
mol_dm_mat <- mol_dm_mat[apply(mol_dm_mat, 1, present), ]
dim(mol_dm_mat)
mol_dm_cpm <- cpm(mol_dm_mat, log = TRUE)
```

Calculate pairwise correlations.

```{r cor-dm}
cor_dm <- cor(mol_dm_cpm)
cor_dm <- cor_dm[upper.tri(cor_dm)]
summary(cor_dm)
```

## Drosophila - 5 pg

Select only samples that received 5 pg.

```{r}
mol_dm_5pg <- mol_dm %>%
  filter(fly == 5000)
dim(mol_dm_5pg)
```

Convert to matrix.

```{r}
mol_dm_mat_5pg <- mol_dm_5pg %>%
  select(starts_with("FBgn")) %>%
  t
```

Only keep fly genes which are observed in at least 50% of the samples.

```{r}
mol_dm_mat_5pg <- mol_dm_mat_5pg[apply(mol_dm_mat_5pg, 1, present), ]
dim(mol_dm_mat_5pg)
mol_dm_cpm_5pg <- cpm(mol_dm_mat_5pg, log = TRUE)
```

Calculate pairwise correlations.

```{r cor-dm-5pg}
cor_dm_5pg <- cor(mol_dm_cpm_5pg)
cor_dm_5pg <- cor_dm_5pg[upper.tri(cor_dm_5pg)]
summary(cor_dm_5pg)
```

## Drosophila - 50 pg

Select only samples that received 50 pg.

```{r}
mol_dm_50pg <- mol_dm %>%
  filter(fly == 50000)
dim(mol_dm_50pg)
```

Convert to matrix.

```{r}
mol_dm_mat_50pg <- mol_dm_50pg %>%
  select(starts_with("FBgn")) %>%
  t
```

Only keep fly genes which are observed in at least 50% of the samples.

```{r}
mol_dm_mat_50pg <- mol_dm_mat_50pg[apply(mol_dm_mat_50pg, 1, present), ]
dim(mol_dm_mat_50pg)
mol_dm_cpm_50pg <- cpm(mol_dm_mat_50pg, log = TRUE)
```

Calculate pairwise correlations.

```{r cor-dm-50pg}
cor_dm_50pg <- cor(mol_dm_cpm_50pg)
cor_dm_50pg <- cor_dm_50pg[upper.tri(cor_dm_50pg)]
summary(cor_dm_50pg)
```

## C. elegans

Remove zeros.

```{r}
mol_ce <- mol_ce %>%
  select_if(function(col) is.character(col) || sum(col) > 0)
dim(mol_ce)
```

Convert to matrix.

```{r}
mol_ce_mat <- mol_ce %>%
  select(starts_with("WBGene")) %>%
  t
```

Only keep worm genes which are observed in at least 50% of the samples.

```{r}
mol_ce_mat <- mol_ce_mat[apply(mol_ce_mat, 1, present), ]
dim(mol_ce_mat)
```

```{r hist-ce}
mol_ce_cpm <- cpm(mol_ce_mat, log = TRUE)
# Remove samples with no observations for this subset
zeros_ce <- colSums(mol_ce_mat) > 0
mol_ce_cpm <- mol_ce_cpm[, zeros_ce]
```

Calculate pairwise correlations.

```{r cor-ce}
cor_ce <- cor(mol_ce_cpm)
cor_ce <- cor_ce[upper.tri(cor_ce)]
summary(cor_ce)
```

## Human

Remove zeros.

```{r}
mol_hs <- mol_hs %>%
  select_if(function(col) is.character(col) || sum(col) > 0)
dim(mol_hs)
```

Convert to matrix.

```{r}
mol_hs_mat <- mol_hs %>%
  select(starts_with("ENSG")) %>%
  t
```

Only keep human genes which are observed in at least 50% of the samples.

```{r}
mol_hs_mat <- mol_hs_mat[apply(mol_hs_mat, 1, present), ]
dim(mol_hs_mat)
mol_hs_cpm <- cpm(mol_hs_mat, log = TRUE)
```

Calculate pairwise correlations.

```{r cor-hs}
cor_hs <- cor(mol_hs_cpm)
cor_hs <- cor_hs[upper.tri(cor_hs)]
summary(cor_hs)
```

## Summary plot

Below are the pairwise correlations for each source of RNA. The numbers along
the bottom are the number of pairwise correlations included in each boxplot (not
all samples received the same spike-ins).

```{r pairwise-correlations}
boxplot(cor_ercc, cor_hs, cor_dm_50pg, cor_dm, cor_dm_5pg, cor_ce,
        names = c("ERCC", "Human", "Fly (50 pg)", "Fly (all)",
                  "Fly (5 pg)", "worm"),
        xlab = "Source", ylab = "Pearson correlation",
        main = "Pairwise correlations")
text(x = 1:6, y = -1, labels = sapply(list(cor_ercc, cor_hs, cor_dm_50pg, cor_dm, cor_dm_5pg, cor_ce), length))
```

## Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
